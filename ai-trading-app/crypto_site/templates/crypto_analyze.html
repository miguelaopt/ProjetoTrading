{% extends "base.html" %}

{% block content %}
<style>
    /* Estilo para os Atalhos Rápidos (Chips) */
    .quick-chips {
        display: flex; gap: 10px; justify-content: center; margin-top: 15px; flex-wrap: wrap;
    }
    .chip {
        background: rgba(255,255,255,0.05); border: 1px solid var(--glass-border);
        padding: 5px 15px; border-radius: 20px; font-size: 0.8rem; color: var(--text-muted);
        cursor: pointer; transition: 0.3s;
    }
    .chip:hover { background: var(--neon-blue); color: black; border-color: var(--neon-blue); }

    /* Estilo para a explicação (Brain Section) */
    .brain-grid {
        display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-top: 40px;
        text-align: left;
    }
    .brain-item h4 { font-size: 0.9rem; margin-bottom: 5px; color: white; }
    .brain-item p { font-size: 0.8rem; color: var(--text-muted); line-height: 1.4; }
    .brain-icon { color: var(--neon-purple); font-size: 1.2rem; margin-bottom: 10px; }
    
    @media (max-width: 768px) { .brain-grid { grid-template-columns: 1fr; } }
</style>

<div class="section-container fade-in" style="max-width: 900px; margin-top: 100px;">
    
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
        <a href="{{ url_for('crypto_page') }}" class="btn-outline" style="text-decoration:none;">
            <i class="fa-solid fa-arrow-left"></i> Voltar
        </a>
        <h2 style="margin:0;"><i class="fa-solid fa-magnifying-glass-chart"></i> Analisador AI</h2>
    </div>

    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px;">
        
        <div class="glass-panel text-center">
            <div class="icon-box"><i class="fa-solid fa-crystal-ball"></i></div>
            <h3>Parâmetros do Trade</h3>
            <p class="text-muted">Diz-nos o que queres negociar.</p>
            
            <div class="input-group mt-20">
                <i class="fa-solid fa-coins"></i>
                <input type="text" id="user-ticker" placeholder="Ex: BTC, SOL, PEPE..." style="text-transform: uppercase;" onkeyup="updateChart()">
            </div>
            
            <div class="quick-chips">
                <div class="chip" onclick="fillTicker('BTC')">BTC</div>
                <div class="chip" onclick="fillTicker('ETH')">ETH</div>
                <div class="chip" onclick="fillTicker('SOL')">SOL</div>
                <div class="chip" onclick="fillTicker('PEPE')">PEPE</div>
            </div>
            
            <div class="input-group mt-20">
                <i class="fa-solid fa-wallet"></i>
                <input type="number" id="user-investment" placeholder="Investimento (€)?">
            </div>

            <button class="btn-glow full-width" onclick="analyzeUserCoin()">
                Gerar Relatório <i class="fa-solid fa-microchip" style="margin-left:8px;"></i>
            </button>
            
            <div class="section-divider" style="margin: 30px 0;"></div>
            <p class="text-muted" style="font-size:0.8rem; text-transform:uppercase; letter-spacing:1px;">Fatores Analisados</p>
            
            <div class="brain-grid">
                <div class="brain-item">
                    <div class="brain-icon"><i class="fa-solid fa-wave-square"></i></div>
                    <h4>Volatilidade</h4>
                    <p>Mede a oscilação do preço para definir o risco de crash.</p>
                </div>
                <div class="brain-item">
                    <div class="brain-icon"><i class="fa-solid fa-arrow-trend-up"></i></div>
                    <h4>Momentum</h4>
                    <p>Verifica se a tendência é de força compradora real.</p>
                </div>
                <div class="brain-item">
                    <div class="brain-icon"><i class="fa-solid fa-newspaper"></i></div>
                    <h4>Sentimento</h4>
                    <p>Interpreta o "humor" do mercado global.</p>
                </div>
            </div>
        </div>

        <div>
            <div class="glass-panel mb-20" style="padding:10px; height: 350px;">
                <div class="tradingview-widget-container" style="height:100%; width:100%">
                    <div id="tradingview_chart" style="height:calc(100% - 32px); width:100%"></div>
                    <div class="tradingview-widget-copyright"><a href="https://www.tradingview.com/" rel="noopener nofollow" target="_blank"><span class="blue-text">Track all markets on TradingView</span></a></div>
                </div>
            </div>

            <div id="analysis-loading" class="hidden glass-panel text-center">
                <span class="loading"><i class="fa-solid fa-circle-notch fa-spin"></i> A consultar os oráculos digitais...</span>
            </div>
            
            <div id="analysis-result" class="hidden fade-in">
                </div>
        </div>

    </div>
</div>

<script type="text/javascript" src="https://s3.tradingview.com/tv.js"></script>
<script>
    // 1. Inicializar Gráfico
    let widget;
    document.addEventListener('DOMContentLoaded', () => {
        loadChart('BTCUSD'); // Default
    });

    function loadChart(symbol) {
        if(widget) return; // Já existe?
        new TradingView.widget({
            "autosize": true,
            "symbol": "BINANCE:" + symbol, // Usa Binance como fonte
            "interval": "D",
            "timezone": "Etc/UTC",
            "theme": "dark",
            "style": "1",
            "locale": "en",
            "enable_publishing": false,
            "allow_symbol_change": false, // O user muda pelo nosso input
            "container_id": "tradingview_chart",
            "hide_top_toolbar": true,     // Mais limpo
            "hide_legend": true,
            "save_image": false,
            "backgroundColor": "rgba(0, 0, 0, 0)" // Transparente
        });
    }

    // 2. Atualizar Gráfico quando user escreve
    let timeout = null;
    function updateChart() {
        clearTimeout(timeout);
        timeout = setTimeout(() => {
            const ticker = document.getElementById('user-ticker').value.toUpperCase();
            if(ticker.length > 2) {
                // Recarregar widget com novo símbolo
                document.getElementById('tradingview_chart').innerHTML = '';
                new TradingView.widget({
                    "autosize": true,
                    "symbol": ticker + "USD", // Tenta adivinhar o par USD
                    "interval": "D",
                    "theme": "dark",
                    "style": "1",
                    "container_id": "tradingview_chart",
                    "hide_top_toolbar": true,
                    "backgroundColor": "rgba(0, 0, 0, 0)"
                });
            }
        }, 1000); // Espera 1s depois de escrever
    }

    // 3. Preencher via Atalho
    function fillTicker(symbol) {
        document.getElementById('user-ticker').value = symbol;
        updateChart();
    }
</script>

<style>
    @media (max-width: 768px) {
        div[style*="grid-template-columns"] { grid-template-columns: 1fr !important; }
    }
</style>
{% endblock %}
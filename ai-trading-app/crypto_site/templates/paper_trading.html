{% extends "base.html" %}

{% block content %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
    /* Layout Grid Principal */
    .dashboard-grid {
        display: grid; grid-template-columns: 2fr 1fr; gap: 30px; margin-top: 30px;
    }
    
    /* Cart√£o de Saldo Principal */
    .balance-card {
        background: linear-gradient(135deg, rgba(20, 10, 30, 0.8), rgba(188, 19, 254, 0.1));
        border: 1px solid var(--neon-purple);
        text-align: center; padding: 40px; position: relative; overflow: hidden;
    }
    .balance-card::before {
        content: ''; position: absolute; top: -50%; left: -50%; width: 200%; height: 200%;
        background: radial-gradient(circle, rgba(188,19,254,0.1) 0%, transparent 70%);
        animation: rotate 20s linear infinite; z-index: 0;
    }
    .balance-content { position: relative; z-index: 1; }
    
    @keyframes rotate { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

    /* Gr√°fico de Aloca√ß√£o */
    .chart-container { position: relative; height: 250px; width: 100%; margin-top: 20px; }

    /* Lista de Cart√µes de Moedas */
    .portfolio-grid {
        display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 15px; margin-top: 20px;
    }
    .coin-card {
        padding: 20px; border-left: 3px solid var(--glass-border); position: relative; transition: 0.3s;
    }
    .coin-card:hover { transform: translateY(-5px); border-left-color: var(--neon-blue); background: rgba(255,255,255,0.05); }
    
    .coin-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
    .coin-symbol { font-weight: bold; font-size: 1.2rem; color: white; }
    .coin-amt { font-size: 0.9rem; color: var(--text-muted); }
    
    .coin-value { font-size: 1.4rem; font-weight: bold; margin-bottom: 5px; }
    .coin-pnl { font-size: 0.9rem; font-weight: 600; display: flex; align-items: center; gap: 5px; }

    /* √Årea de Trade com Gr√°fico */
    .trade-section { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
    @media (max-width: 900px) { 
        .dashboard-grid { grid-template-columns: 1fr; } 
        .trade-section { grid-template-columns: 1fr; }
    }
</style>

<div class="section-container fade-in" style="max-width: 1200px; margin-top: 100px;">
    
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
        <div>
            <h2 style="margin:0;"><i class="fa-solid fa-gamepad" style="color:#f1c40f;"></i> Paper Trading</h2>
            <p class="text-muted">Simulador de Mercado em Tempo Real.</p>
        </div>
        <a href="{{ url_for('reset_account') }}" class="btn-outline" onclick="return confirm('Tens a certeza? Isto apaga todo o teu progresso.')">
            <i class="fa-solid fa-rotate-right"></i><span>Reset Conta</span>
        </a>
    </div>

    <div class="dashboard-grid">
        
        <div>
            <div class="glass-panel balance-card">
                <div class="balance-content">
                    <p class="text-muted" style="text-transform:uppercase; letter-spacing:2px; font-size:0.8rem;">Patrim√≥nio Total</p>
                    <h1 style="font-size: 3.5rem; margin: 10px 0; text-shadow: 0 0 20px rgba(255,255,255,0.5);">
                        ${{ "{:,.2f}".format(net_worth) }}
                    </h1>
                    <div style="display:inline-block; padding: 5px 15px; background:rgba(255,255,255,0.1); border-radius:20px;">
                        <i class="fa-solid fa-wallet"></i> Dispon√≠vel: <b>${{ "{:,.2f}".format(current_user.virtual_balance) }}</b>
                    </div>
                </div>
            </div>

            <h3 class="mt-20"><i class="fa-solid fa-layer-group"></i> A Tua Carteira</h3>
            
            {% if portfolio %}
            <div class="portfolio-grid">
                {% for item in portfolio %}
                <div class="glass-panel coin-card">
                    <div class="coin-header">
                        <span class="coin-symbol">{{ item.symbol }}</span>
                        <span class="coin-amt">{{ "{:.4f}".format(item.amount) }} uni</span>
                    </div>
                    <div class="coin-value">${{ "{:,.2f}".format(item.total_value) }}</div>
                    
                    <div class="coin-pnl {{ 'green' if item.profit_pct >= 0 else 'red' }}">
                        {% if item.profit_pct >= 0 %}
                            <i class="fa-solid fa-arrow-trend-up"></i>
                        {% else %}
                            <i class="fa-solid fa-arrow-trend-down"></i>
                        {% endif %}
                        {{ "{:+.2f}%".format(item.profit_pct) }} (${{ "{:+.2f}".format(item.profit_abs) }})
                    </div>
                    <div style="font-size:0.7rem; color:#666; margin-top:10px;">
                        Avg: ${{ "{:,.2f}".format(item.avg_price) }}
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <div class="glass-panel text-center mt-20" style="padding:40px;">
                <i class="fa-solid fa-box-open" style="font-size:3rem; color:var(--text-muted); opacity:0.5;"></i>
                <p>A tua carteira est√° vazia. Come√ßa a negociar abaixo!</p>
            </div>
            {% endif %}

            <details class="glass-panel mt-20" style="padding:10px;">
    <summary style="cursor:pointer; padding:10px; font-weight:bold; color:var(--text-muted);">
        üìú Ver Hist√≥rico de Transa√ß√µes
    </summary>
    
    <div class="table-responsive">
        <table class="market-table-full" style="margin-top:10px;">
            <thead>
                <tr>
                    <th>Data</th>
                    <th>Tipo</th>
                    <th>Ativo</th>
                    <th class="text-right">Pre√ßo Exec.</th>
                    <th class="text-right">Qtd.</th>
                    <th class="text-right">Valor Total</th>
                </tr>
            </thead>
            <tbody>
                {% for tx in transactions %}
                <tr>
                    <td style="font-size:0.85rem; color:#aaa;">{{ tx.timestamp.strftime('%d/%m %H:%M') }}</td>
                    <td>
                        <span style="padding:3px 8px; border-radius:4px; font-size:0.75rem; background: {{ 'rgba(46, 204, 113, 0.2)' if tx.type == 'BUY' else 'rgba(231, 76, 60, 0.2)' }}; color: {{ '#2ecc71' if tx.type == 'BUY' else '#e74c3c' }}; border: 1px solid {{ '#2ecc71' if tx.type == 'BUY' else '#e74c3c' }};">
                            {{ tx.type }}
                        </span>
                    </td>
                    <td style="font-weight:bold;">{{ tx.symbol }}</td>
                    <td class="text-right" style="font-family:monospace;">${{ "{:,.2f}".format(tx.price) }}</td>
                    <td class="text-right" style="font-family:monospace;">{{ "{:.6f}".format(tx.amount) }}</td>
                    <td class="text-right" style="font-weight:bold;">${{ "{:,.2f}".format(tx.total_value) }}</td>
                </tr>
                {% else %}
                <tr>
                    <td colspan="6" class="text-center" style="padding:20px; color:#666;">
                        Ainda n√£o fizeste nenhuma transa√ß√£o.
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</details>
        </div>

        <div>
            <div class="glass-panel mb-20 text-center">
                <h4><i class="fa-solid fa-chart-pie"></i> Aloca√ß√£o</h4>
                <div class="chart-container">
                    <canvas id="allocationChart"></canvas>
                </div>
            </div>

    <div class="glass-panel">
    <h3 style="margin-bottom:15px;"><i class="fa-solid fa-bolt"></i> Nova Ordem</h3>
    
    <form action="{{ url_for('execute_trade') }}" method="POST">
        <div class="input-group">
            <i class="fa-solid fa-magnifying-glass"></i>
            <input type="text" name="symbol" id="trade-symbol" placeholder="S√≠mbolo (ex: BTC)" required onkeyup="updateTradeChart()" style="text-transform: uppercase;">
        </div>
        
        <div id="mini-chart-container" style="height: 150px; background:rgba(0,0,0,0.3); border-radius:8px; margin-bottom:15px; overflow:hidden;">
            <div id="tradingview_mini" style="height:100%; width:100%"></div>
        </div>

        <div style="display:flex; gap:10px; margin-bottom:10px;">
            <div style="flex:1;">
                <label style="font-size:0.8rem; color:#aaa; margin-left:5px;">Tipo de Entrada</label>
                <select name="trade_mode" id="trade-mode" style="background:rgba(255,255,255,0.1); border:1px solid var(--glass-border); color:white; padding:10px; border-radius:8px; width:100%; outline:none;" onchange="updatePlaceholder()">
                    <option value="fiat">Por Valor ($ USD)</option>
                    <option value="units">Por Unidade (Qtd)</option>
                </select>
            </div>
            
            <div style="flex:1;">
                <label style="font-size:0.8rem; color:#aaa; margin-left:5px;">Valor / Quantidade</label>
                <div class="input-group" style="margin-bottom:0;">
                    <i class="fa-solid fa-hashtag" id="input-icon"></i>
                    <input type="number" step="0.000001" name="amount" id="trade-amount" placeholder="Ex: 100 ($)" required>
                </div>
            </div>
        </div>

        <div style="display:flex; gap:10px; margin-top:20px;">
            <button type="submit" name="action" value="BUY" class="btn-glow full-width" style="background:var(--success); border-color:var(--success);">
                Comprar
            </button>
            <button type="submit" name="action" value="SELL" class="btn-glow full-width" style="background:var(--danger); border-color:var(--danger);">
                Vender
            </button>
        </div>
    </form>
</div>
        </div>

    </div>
</div>

<script>
    function updatePlaceholder() {
        const mode = document.getElementById('trade-mode').value;
        const input = document.getElementById('trade-amount');
        const icon = document.getElementById('input-icon');
        
        if(mode === 'fiat') {
            input.placeholder = "Ex: 500 ($)";
            icon.className = "fa-solid fa-dollar-sign";
        } else {
            input.placeholder = "Ex: 0.5 (Moedas)";
            icon.className = "fa-solid fa-hashtag";
        }
    }
    // Correr uma vez ao iniciar
    document.addEventListener('DOMContentLoaded', updatePlaceholder);
</script>

<script type="text/javascript" src="https://s3.tradingview.com/tv.js"></script>
<script>
    // 1. Gr√°fico de Aloca√ß√£o (Chart.js)
    const ctx = document.getElementById('allocationChart').getContext('2d');
    const allocData = {{ alloc_data|safe }};
    const allocLabels = {{ alloc_labels|safe }};

    if(allocData.length > 0) {
        new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: allocLabels,
                datasets: [{
                    data: allocData,
                    backgroundColor: [
                        '#3498db', '#9b59b6', '#2ecc71', '#f1c40f', '#e74c3c', '#34495e'
                    ],
                    borderWidth: 0
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { position: 'bottom', labels: { color: 'white', boxWidth: 10 } }
                }
            }
        });
    } else {
        document.getElementById('allocationChart').style.display = 'none';
        document.querySelector('.chart-container').innerHTML = "<p class='text-muted' style='padding-top:100px;'>Sem ativos para mostrar.</p>";
    }

    // 2. Gr√°fico Mini TradingView (Atualiza ao escrever)
    let tvWidget = null;
    let typingTimer;
    
    // Iniciar com BTC
    loadMiniChart('BTCUSD');

    function updateTradeChart() {
        clearTimeout(typingTimer);
        typingTimer = setTimeout(() => {
            const symbol = document.getElementById('trade-symbol').value.toUpperCase();
            if(symbol.length >= 3) {
                loadMiniChart(symbol + "USD");
            }
        }, 800);
    }

    function loadMiniChart(symbol) {
        document.getElementById('tradingview_mini').innerHTML = "";
        new TradingView.widget({
            "autosize": true,
            "symbol": "BINANCE:" + symbol,
            "interval": "D",
            "timezone": "Etc/UTC",
            "theme": "dark",
            "style": "2", // Linha (Line Chart) para ser mais limpo no mini
            "locale": "en",
            "toolbar_bg": "#f1f3f6",
            "enable_publishing": false,
            "hide_top_toolbar": true,
            "hide_legend": true,
            "save_image": false,
            "container_id": "tradingview_mini",
            "backgroundColor": "rgba(0,0,0,0)"
        });
    }
</script>
{% endblock %}